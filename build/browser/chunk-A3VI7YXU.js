import{a as $,b as H}from"./chunk-BC2RRGYI.js";import{a as S,b as A}from"./chunk-AWQM7IIM.js";import{a as L,b as j,c as z}from"./chunk-VMKVCHVW.js";import{a as F}from"./chunk-IJB3HI4L.js";import{a as T,b as D}from"./chunk-MNJUUXAV.js";import{c as V}from"./chunk-Y2GQIFGB.js";import"./chunk-6C43PQNK.js";import"./chunk-SGGM3K3A.js";import{w}from"./chunk-LTEV2KH7.js";import{i as O}from"./chunk-NKZL4UVF.js";import{Fb as b,Hb as m,Ib as u,Oa as l,Pc as I,Qc as M,Rc as k,Ub as v,Wb as o,Xb as C,Yb as x,Yc as y,Za as _,_b as N,db as R,ha as p,hc as E,ia as f,ib as h,v as P,vb as d,wb as r,xb as n,yb as g}from"./chunk-S4NM23YD.js";import"./chunk-CSTXWUWE.js";var J=()=>[];function U(s,t){if(s&1){let e=b();r(0,"div",17),o(1),r(2,"button",18),m("click",function(){let a=p(e).$implicit,c=u();return f(c.closeToast(a))}),o(3,"\xD7"),n()()}if(s&2){let e=t.$implicit;v("show",e.visible),d("ngClass",e.type),l(),x(" ",e.message," ")}}function B(s,t){if(s&1&&(r(0,"div",19),g(1,"i",20),o(2),n()),s&2){let e=u();l(2),x(" ",e.error," ")}}function G(s,t){s&1&&g(0,"mat-progress-spinner",21)}function K(s,t){if(s&1){let e=b();r(0,"tr")(1,"td"),o(2),n(),r(3,"td"),o(4),n(),r(5,"td"),o(6),n(),r(7,"td")(8,"span",25)(9,"i",26),o(10),n(),o(11),n()(),r(12,"td")(13,"div",27)(14,"button",28),m("click",function(){let a=p(e).$implicit,c=u(2);return f(c.updateRegle(a))}),g(15,"i",29),n(),r(16,"button",30),m("click",function(){let a=p(e).$implicit,c=u(2);return f(c.supprimerRegle(a))}),g(17,"i",31),n()()()()}if(s&2){let e=t.$implicit,i=u(2);l(2),C(e.regleCalcul.idRegleCalcul),l(2),C(e.sousNature.nomSousNature||""),l(2),C(i.categorieMap[e.nature.typeNature]),l(2),d("ngClass",e.regleCalcul.status?"badge-actif":"badge-inactif"),l(2),x(" ",e.regleCalcul.status?"\u2714":"\u2716"," "),l(),x(" ",e.regleCalcul.status?"ACTIF":"INACTIF"," ")}}function Q(s,t){if(s&1&&(r(0,"table",22)(1,"thead",23)(2,"tr")(3,"th"),o(4,"ID"),n(),r(5,"th"),o(6,"Nom"),n(),r(7,"th"),o(8,"Cat\xE9gorie"),n(),r(9,"th"),o(10,"Status"),n(),r(11,"th"),o(12,"Actions"),n()()(),r(13,"tbody"),h(14,K,18,6,"tr",24),n()()),s&2){let e=u();l(14),d("ngForOf",e.elements)}}function W(s,t){if(s&1){let e=b();r(0,"li",35)(1,"a",36),m("click",function(a){let c=p(e).index;return u(2).goToPage(c+1),f(a.preventDefault())}),o(2),n()()}if(s&2){let e=t.index,i=u(2);v("active",i.pageIndex===e+1),l(2),x(" ",e+1," ")}}function X(s,t){if(s&1){let e=b();r(0,"div",32)(1,"div")(2,"p",33),o(3),n()(),r(4,"nav")(5,"ul",34)(6,"li",35)(7,"a",36),m("click",function(a){return p(e),u().previousPage(),f(a.preventDefault())}),g(8,"i",37),n()(),h(9,W,3,3,"li",38),r(10,"li",35)(11,"a",36),m("click",function(a){return p(e),u().nextPage(),f(a.preventDefault())}),g(12,"i",39),n()()()()()}if(s&2){let e=u();l(3),N(" Page ",e.pageIndex," sur ",e.totalPages," (",e.total," nature(s) au total) "),l(3),v("disabled",e.pageIndex===1),l(3),d("ngForOf",E(8,J).constructor(e.totalPages)),l(),v("disabled",e.pageIndex===e.totalPages)}}var q=class s{constructor(t,e,i,a,c){this.natureService=t;this.sousNatureService=e;this.regleCalculService=i;this.router=a;this.dialog=c}error=null;pageIndex=1;pageSize=10;total=0;totalPages=1;actifOnly=!1;searchTerm="";Math=Math;isLoading=!0;natures=[];sousNatures=[];newRegleCalculs=[];regleCalculs=[];elements=[];typeCategorieList=Object.entries(L).map(([t,e])=>({key:t,label:e}));categorieMap={};toasts=[];showToast(t,e="success"){let i={message:t,type:e,visible:!1};this.toasts.push(i),requestAnimationFrame(()=>{i.visible=!0}),i.timeout=setTimeout(()=>this.closeToast(i),3e3)}closeToast(t){clearTimeout(t.timeout),t.visible=!1,setTimeout(()=>{this.toasts=this.toasts.filter(e=>e!==t)},400)}ngOnInit(){this.categorieMap=this.typeCategorieList.reduce((t,e)=>(t[e.key]=e.label,t),{}),this.loadPageData()}loadPageData(){this.isLoading=!0,P({sousNatures:this.sousNatureService.listSousNatures(1,1e3),natures:this.natureService.listNatures(1,1e3),regleCalculs:this.regleCalculService.listRegleCalculs(this.pageIndex,this.pageSize,["REV","DEP","INV","FIN","FDR","TRE"])}).subscribe({next:({sousNatures:t,natures:e,regleCalculs:i})=>{t&&t.success&&t.data&&e&&e.success&&e.data?(this.total=i.data.total,this.totalPages=i.data.total_pages,this.pageIndex=i.data.page,this.sousNatures=t.data.sous_natures.map(a=>S.fromResponse(a)),this.natures=e.data.base_natures.map(a=>j.fromResponse(a)),this.regleCalculs=i.data.regles_calcul.map(a=>$.fromResponse(a)),this.buildElement(),this.isLoading=!1):(this.error=t?.message||"Erreur lors du chargement des natures",this.natures=[],this.sousNatures=[],this.regleCalculs=[]),this.isLoading=!1},error:()=>(this.error="Erreur lors du chargement des natures",this.isLoading=!1)})}buildElement(){this.elements=this.regleCalculs.map(t=>{let e=this.sousNatures.find(a=>a.idSousNature===t.idSousNature),i=e?this.natures.find(a=>a.idNature===e.idNature):void 0;return{sousNature:e,nature:i??{},regleCalcul:t}})}search(){if(this.searchTerm.trim().length===0){this.loadPageData();return}this.isLoading=!0,this.error=null,this.sousNatureService.searchSousNature(this.searchTerm).subscribe({next:t=>{t&&t.success&&t.data?(this.sousNatures=t.data.map(e=>S.fromResponse(e)),this.buildElement(),this.total=this.natures.length,this.totalPages=1):(this.error=t?.message||"Aucune sous sous-nature trouv\xE9e",this.natures=[]),this.isLoading=!1},error:t=>{this.error="Erreur lors de la recherche",this.isLoading=!1,console.error("Erreur:",t)}})}goToPage(t){t>=1&&t<=this.totalPages&&(this.pageIndex=t,this.loadPageData())}previousPage(){this.pageIndex>1&&(this.pageIndex--,this.loadPageData())}nextPage(){this.pageIndex<this.totalPages&&(this.pageIndex++,this.loadPageData())}addRegle(){this.router.navigate(["regle-calculs/create"])}supprimerRegle(t){this.dialog.open(F,{width:"350px",data:{title:"Confirmation",message:"Voulez-vous vraiment supprimer la regle "+t.sousNature.nomSousNature+" ?",cancel:"Non",valid:"Oui"}}).afterClosed().subscribe(i=>{i===!0&&this.regleCalculService.deleteRegleCalcul(t.regleCalcul).subscribe(a=>{this.showToast(["Suppression r\xE9ussie !"],"success"),this.loadPageData()},a=>{let c=[];c.push(a.error?.message||"Erreur inconnue."),this.showToast(c,"error")})})}updateRegle(t){this.regleCalculService.setRegleCalculToEdit(t.regleCalcul),this.router.navigate(["regle-calculs/edit"])}static \u0275fac=function(e){return new(e||s)(_(z),_(A),_(H),_(O),_(V))};static \u0275cmp=R({type:s,selectors:[["app-regle-calculs"]],decls:24,vars:5,consts:[[1,"toast-container"],["class","toast",3,"ngClass","show",4,"ngFor","ngForOf"],[1,"row"],[1,"col-12"],[1,"card"],[1,"card-header"],[1,"card-title"],[1,"fas","fa-user-tie","mr-2"],[1,"card-tools"],["type","button",1,"btn","btn-primary",3,"click"],[1,"fas","fa-plus"],[1,"card-body"],[1,"row","mb-3"],["class","alert alert-danger",4,"ngIf"],["mode","indeterminate","diameter","50","style","display: block; margin: 0 auto;",4,"ngIf"],["class","table table-bordered table-hover",4,"ngIf"],["class","d-flex justify-content-between align-items-center mt-3",4,"ngIf"],[1,"toast",3,"ngClass"],[1,"close-btn",3,"click"],[1,"alert","alert-danger"],[1,"fas","fa-exclamation-triangle"],["mode","indeterminate","diameter","50",2,"display","block","margin","0 auto"],[1,"table","table-bordered","table-hover"],[1,"thead-dark"],[4,"ngFor","ngForOf"],[1,"badge","statut-badge",3,"ngClass"],[1,"status-icon"],["role","group",1,"btn-group"],[1,"btn","btn-sm","btn-info","mr-1",3,"click"],[1,"fas","fa-edit"],[1,"btn","btn-sm","btn-danger",3,"click"],[1,"fas","fa-trash"],[1,"d-flex","justify-content-between","align-items-center","mt-3"],[1,"text-muted","mb-0"],[1,"pagination","mb-0"],[1,"page-item"],["href","#",1,"page-link",3,"click"],[1,"fas","fa-chevron-left"],["class","page-item",3,"active",4,"ngFor","ngForOf"],[1,"fas","fa-chevron-right"]],template:function(e,i){e&1&&(r(0,"div",0),h(1,U,4,4,"div",1),n(),r(2,"div",2)(3,"div",3)(4,"div",4)(5,"div",5)(6,"h2",6),g(7,"i",7),r(8,"b"),o(9," R\xE8gle-Calcul "),n(),o(10," - "),r(11,"i"),o(12,"Listing"),n(),o(13," - "),n(),r(14,"div",8)(15,"button",9),m("click",function(){return i.addRegle()}),g(16,"i",10),o(17," Nouvelle R\xE8gle "),n()()(),r(18,"div",11),g(19,"div",12),h(20,B,3,1,"div",13)(21,G,1,0,"mat-progress-spinner",14)(22,Q,15,1,"table",15)(23,X,13,9,"div",16),n()()()()),e&2&&(l(),d("ngForOf",i.toasts),l(19),d("ngIf",i.error),l(),d("ngIf",i.isLoading),l(),d("ngIf",!i.isLoading),l(),d("ngIf",i.totalPages>1))},dependencies:[y,I,M,k,w,D,T],styles:[".table-responsive[_ngcontent-%COMP%]{border-radius:8px;overflow:hidden;box-shadow:0 4px 12px #1111111a}.table[_ngcontent-%COMP%]   thead[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{background-color:#5d83a9;color:#fff;text-align:center}.table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{vertical-align:middle}.table-row-hover[_ngcontent-%COMP%]:hover{background-color:#f1f3f5;transition:background .25s ease}.badge.statut-badge[_ngcontent-%COMP%]{display:inline-flex;align-items:center;padding:.25em .6em;font-size:.85em;font-weight:600;border-radius:.25rem}.badge-actif[_ngcontent-%COMP%]{background-color:#28a745;color:#fff}.badge-inactif[_ngcontent-%COMP%]{background-color:#dc3545;color:#fff}.status-icon[_ngcontent-%COMP%]{display:inline-block;margin-right:.4em;font-size:.9em}.builder-container[_ngcontent-%COMP%]{max-width:800px;margin:30px auto;padding:25px;border-radius:10px;background:#fafafa;box-shadow:0 2px 10px #0000001a;font-family:Segoe UI,sans-serif}.clear[_ngcontent-%COMP%]{background-color:#dc3545}.clear[_ngcontent-%COMP%]:hover{background-color:#a71d2a}.save[_ngcontent-%COMP%]{background-color:#28a745}.save[_ngcontent-%COMP%]:hover{background-color:#1e7e34}.calc[_ngcontent-%COMP%]{background-color:#17a2b8}.calc[_ngcontent-%COMP%]:hover{background-color:#117a8b}.result[_ngcontent-%COMP%]{margin-top:15px;font-size:18px;background:#e3f7e6;border:1px solid #a4d7b5;padding:10px;border-radius:5px;color:#155724}.toast-container[_ngcontent-%COMP%]{position:fixed;top:20px;right:20px;display:flex;flex-direction:column;gap:10px;z-index:9999}.toast[_ngcontent-%COMP%]{min-width:220px;padding:12px 16px;border-radius:6px;color:#fff;box-shadow:0 4px 12px #00000040;font-size:14px;display:flex;justify-content:space-between;align-items:center;opacity:0;transform:translate(100%);transition:transform .4s ease,opacity .4s ease}.toast.show[_ngcontent-%COMP%]{opacity:1;transform:translate(0)}.toast.success[_ngcontent-%COMP%]{background-color:#4caf50}.toast.error[_ngcontent-%COMP%]{background-color:#f44336}.toast[_ngcontent-%COMP%]   .close-btn[_ngcontent-%COMP%]{background:none;border:none;color:#fff;font-size:16px;line-height:1;cursor:pointer}"]})};export{q as RegleCalculs};
