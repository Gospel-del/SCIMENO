import{a as z}from"./chunk-3ICLOKWM.js";import{b as L}from"./chunk-BC2RRGYI.js";import{b as j}from"./chunk-AWQM7IIM.js";import{a as B,c as V}from"./chunk-VMKVCHVW.js";import{a as D}from"./chunk-IJB3HI4L.js";import{a as T}from"./chunk-MNJUUXAV.js";import{c as R}from"./chunk-Y2GQIFGB.js";import"./chunk-6C43PQNK.js";import"./chunk-SGGM3K3A.js";import{w as O}from"./chunk-LTEV2KH7.js";import{i as M}from"./chunk-NKZL4UVF.js";import{Fb as v,Hb as p,Ib as u,Oa as l,Pc as w,Qc as E,Rc as F,Ub as x,Wb as n,Xb as C,Yb as h,Yc as k,Za as _,_b as N,db as P,ha as g,hc as y,ia as f,ib as b,v as I,vb as d,wb as r,xb as a,yb as m}from"./chunk-S4NM23YD.js";import"./chunk-CSTXWUWE.js";var S=(i=>(i.ICA="Indicateurs li\xE9s au chiffre d\u2019affaires",i.IDR="Indicateurs de Rentabilit\xE9",i.ISF="Indicateurs de Structure Financi\xE8re",i))(S||{});var G=()=>[];function H(s,t){if(s&1){let e=v();r(0,"div",15),n(1),r(2,"button",16),p("click",function(){let o=g(e).$implicit,c=u();return f(c.closeToast(o))}),n(3,"\xD7"),a()()}if(s&2){let e=t.$implicit;x("show",e.visible),d("ngClass",e.type),l(),h(" ",e.message," ")}}function q(s,t){s&1&&m(0,"mat-progress-spinner",17)}function J(s,t){if(s&1){let e=v();r(0,"tr")(1,"td"),n(2),a(),r(3,"td"),n(4),a(),r(5,"td"),n(6),a(),r(7,"td")(8,"span",21)(9,"i",22),n(10),a(),n(11),a()(),r(12,"td")(13,"div",23)(14,"button",24),p("click",function(){let o=g(e).$implicit,c=u(2);return f(c.updateRegle(o))}),m(15,"i",25),n(16," Modifier "),a(),r(17,"button",26),p("click",function(){let o=g(e).$implicit,c=u(2);return f(c.supprimerRegle(o))}),m(18,"i",27),n(19," Supprimer "),a()()()()}if(s&2){let e=t.$implicit,i=u(2);l(2),C(e.regleCalcul.idRegleCalcul),l(2),C(e.sousNature.nomSousNature),l(2),C(i.categorieMap[e.nature.typeNature]),l(2),d("ngClass",e.regleCalcul.status?"badge-actif":"badge-inactif"),l(2),h(" ",e.regleCalcul.status?"\u2714":"\u2716"," "),l(),h(" ",e.regleCalcul.status?"ACTIF":"INACTIF"," ")}}function K(s,t){if(s&1&&(r(0,"table",18)(1,"thead",19)(2,"tr")(3,"th"),n(4,"ID"),a(),r(5,"th"),n(6,"Nom"),a(),r(7,"th"),n(8,"Cat\xE9gorie"),a(),r(9,"th"),n(10,"Status"),a(),r(11,"th"),n(12,"Actions"),a()()(),r(13,"tbody"),b(14,J,20,6,"tr",20),a()()),s&2){let e=u();l(14),d("ngForOf",e.elements)}}function Q(s,t){if(s&1){let e=v();r(0,"li",31)(1,"a",32),p("click",function(o){let c=g(e).index;return u(2).goToPage(c+1),f(o.preventDefault())}),n(2),a()()}if(s&2){let e=t.index,i=u(2);x("active",i.pageIndex===e+1),l(2),h(" ",e+1," ")}}function U(s,t){if(s&1){let e=v();r(0,"div",28)(1,"div")(2,"p",29),n(3),a()(),r(4,"nav")(5,"ul",30)(6,"li",31)(7,"a",32),p("click",function(o){return g(e),u().previousPage(),f(o.preventDefault())}),m(8,"i",33),a()(),b(9,Q,3,3,"li",34),r(10,"li",31)(11,"a",32),p("click",function(o){return g(e),u().nextPage(),f(o.preventDefault())}),m(12,"i",35),a()()()()()}if(s&2){let e=u();l(3),N(" Page ",e.pageIndex," sur ",e.totalPages," (",e.total," nature(s) au total) "),l(3),x("disabled",e.pageIndex===1),l(3),d("ngForOf",y(8,G).constructor(e.totalPages)),l(),x("disabled",e.pageIndex===e.totalPages)}}var A=class s{constructor(t,e,i,o,c,$){this.natureService=t;this.sousNatureService=e;this.regleCalculService=i;this.globalFonctionService=o;this.router=c;this.dialog=$}pageIndex=1;pageSize=10;total=0;totalPages=0;Math=Math;isLoading=!0;natures=[];sousNatures=[];newRegleCalculs=[];regleCalculs=[];elements=[];allowedInd=new Set;typeCategorieList=Object.entries(B).map(([t,e])=>({key:t,label:e}));typeIndicateurList=Object.entries(S).map(([t,e])=>({key:t,label:e}));categorieMap={};toasts=[];showToast(t,e="success"){let i={message:t,type:e,visible:!1};this.toasts.push(i),requestAnimationFrame(()=>{i.visible=!0}),i.timeout=setTimeout(()=>this.closeToast(i),3e3)}closeToast(t){clearTimeout(t.timeout),t.visible=!1,setTimeout(()=>{this.toasts=this.toasts.filter(e=>e!==t)},400)}ngOnInit(){this.categorieMap=this.typeCategorieList.reduce((t,e)=>(t[e.key]=e.label,t),{}),this.typeIndicateurList.forEach(t=>{this.allowedInd.add(t.key)}),this.loadPageData()}loadPageData(){this.isLoading=!0,I({sousNatures:this.sousNatureService.listSousNatures(1,1e3),natures:this.natureService.listNatures(1,1e3),regleCalculs:this.regleCalculService.listRegleCalculs(this.pageIndex,this.pageSize,["IND"])}).subscribe({next:({sousNatures:t,natures:e,regleCalculs:i})=>{t&&t.success&&t.data&&e&&e.success&&e.data&&i&&i.success&&i.data&&(this.sousNatures=t.data.sous_natures,this.natures=e.data.base_natures,this.regleCalculs=i.data.regles_calcul,this.total=i.data.total,this.pageIndex=i.data.page,this.totalPages=i.data.total_pages,this.buildElement(),this.isLoading=!1)},error:()=>this.isLoading=!1})}buildElement(){this.elements=this.regleCalculs.map(t=>{let e=this.sousNatures.find(o=>o.idSousNature===t.idSousNature),i=e?this.natures.find(o=>o.idNature===e.idNature):void 0;return{sousNature:e,nature:i??{},regleCalcul:t}})}onPageChange(t){let e=Math.ceil(this.total/this.pageSize);t<1||t>e||(this.pageIndex=t,this.loadPageData())}addRegle(){this.router.navigate(["indicateur-cle/create"])}goToPage(t){t>=1&&t<=this.totalPages&&(this.pageIndex=t,this.loadPageData())}previousPage(){this.pageIndex>1&&(this.pageIndex--,this.loadPageData())}nextPage(){this.pageIndex<this.totalPages&&(this.pageIndex++,this.loadPageData())}supprimerRegle(t){this.dialog.open(D,{width:"350px",data:{title:"Confirmation",message:"Voulez-vous vraiment supprimer la regle "+t.sousNature.nomSousNature+" ?",cancel:"Non",valid:"Oui"}}).afterClosed().subscribe(i=>{i===!0&&this.regleCalculService.deleteRegleCalcul(t.regleCalcul).subscribe(o=>{this.showToast(["Suppression r\xE9ussie !"],"success"),this.loadPageData()},o=>{let c=[];c.push(o.error?.message||"Erreur inconnue."),this.showToast(c,"error")})})}updateRegle(t){this.regleCalculService.setRegleCalculToEdit(t.regleCalcul),this.router.navigate(["indicateur-cle/edit"])}static \u0275fac=function(e){return new(e||s)(_(V),_(j),_(L),_(z),_(M),_(R))};static \u0275cmp=P({type:s,selectors:[["app-formule-builder"]],decls:22,vars:4,consts:[[1,"toast-container"],["class","toast",3,"ngClass","show",4,"ngFor","ngForOf"],[1,"row"],[1,"col-12"],[1,"card"],[1,"card-header"],[1,"card-title"],[1,"fas","fa-user-tie","mr-2"],[1,"card-tools"],["type","button",1,"btn","btn-primary",3,"click"],[1,"fas","fa-plus"],[1,"card-body"],["mode","indeterminate","diameter","50","style","display: block; margin: 0 auto;",4,"ngIf"],["class","table table-bordered table-hover",4,"ngIf"],["class","d-flex justify-content-between align-items-center mt-3",4,"ngIf"],[1,"toast",3,"ngClass"],[1,"close-btn",3,"click"],["mode","indeterminate","diameter","50",2,"display","block","margin","0 auto"],[1,"table","table-bordered","table-hover"],[1,"thead-dark"],[4,"ngFor","ngForOf"],[1,"badge","statut-badge",3,"ngClass"],[1,"status-icon"],["role","group",1,"btn-group"],[1,"btn","btn-sm","btn-info","mr-1",3,"click"],[1,"fas","fa-edit"],[1,"btn","btn-sm","btn-danger",3,"click"],[1,"fas","fa-trash"],[1,"d-flex","justify-content-between","align-items-center","mt-3"],[1,"text-muted","mb-0"],[1,"pagination","mb-0"],[1,"page-item"],["href","#",1,"page-link",3,"click"],[1,"fas","fa-chevron-left"],["class","page-item",3,"active",4,"ngFor","ngForOf"],[1,"fas","fa-chevron-right"]],template:function(e,i){e&1&&(r(0,"div",0),b(1,H,4,4,"div",1),a(),r(2,"div",2)(3,"div",3)(4,"div",4)(5,"div",5)(6,"h2",6),m(7,"i",7),r(8,"b"),n(9," Indicateur-cl\xE9s "),a(),n(10," - "),r(11,"i"),n(12,"Listing"),a(),n(13," - "),a(),r(14,"div",8)(15,"button",9),p("click",function(){return i.addRegle()}),m(16,"i",10),n(17," Nouvel element "),a()()(),r(18,"div",11),b(19,q,1,0,"mat-progress-spinner",12)(20,K,15,1,"table",13)(21,U,13,9,"div",14),a()()()()),e&2&&(l(),d("ngForOf",i.toasts),l(18),d("ngIf",i.isLoading),l(),d("ngIf",!i.isLoading),l(),d("ngIf",i.totalPages>1))},dependencies:[O,k,w,E,F,T],styles:[".table-responsive[_ngcontent-%COMP%]{border-radius:8px;overflow:hidden;box-shadow:0 4px 12px #1111111a}.table[_ngcontent-%COMP%]   thead[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{background-color:#5d83a9;color:#fff;text-align:center}.table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{vertical-align:middle}.table-row-hover[_ngcontent-%COMP%]:hover{background-color:#f1f3f5;transition:background .25s ease}.badge.statut-badge[_ngcontent-%COMP%]{display:inline-flex;align-items:center;padding:.25em .6em;font-size:.85em;font-weight:600;border-radius:.25rem}.badge-actif[_ngcontent-%COMP%]{background-color:#28a745;color:#fff}.badge-inactif[_ngcontent-%COMP%]{background-color:#dc3545;color:#fff}.status-icon[_ngcontent-%COMP%]{display:inline-block;margin-right:.4em;font-size:.9em}.toast-container[_ngcontent-%COMP%]{position:fixed;top:20px;right:20px;display:flex;flex-direction:column;gap:10px;z-index:9999}.toast[_ngcontent-%COMP%]{min-width:220px;padding:12px 16px;border-radius:6px;color:#fff;box-shadow:0 4px 12px #00000040;font-size:14px;display:flex;justify-content:space-between;align-items:center;opacity:0;transform:translate(100%);transition:transform .4s ease,opacity .4s ease}.toast.show[_ngcontent-%COMP%]{opacity:1;transform:translate(0)}.toast.success[_ngcontent-%COMP%]{background-color:#4caf50}.toast.error[_ngcontent-%COMP%]{background-color:#f44336}.toast[_ngcontent-%COMP%]   .close-btn[_ngcontent-%COMP%]{background:none;border:none;color:#fff;font-size:16px;line-height:1;cursor:pointer}"]})};export{A as FormuleBuilder};
