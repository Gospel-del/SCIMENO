import{a as de}from"./chunk-LQZFU4YQ.js";import{a as ce}from"./chunk-L76IVEF3.js";import{d as te,f as ie,j as re,k as le}from"./chunk-ZJQO5VS5.js";import{a as ue}from"./chunk-3ICLOKWM.js";import{b as ae}from"./chunk-BC2RRGYI.js";import{b as se}from"./chunk-AWQM7IIM.js";import{a as oe,c as ne}from"./chunk-VMKVCHVW.js";import{a as ee}from"./chunk-MNJUUXAV.js";import{a as j,b as B,e as z,f as $,g as q,i as G,j as H,n as U,o as J,p as K,s as Q,u as X,w as Y,x as Z}from"./chunk-LTEV2KH7.js";import{i as W}from"./chunk-NKZL4UVF.js";import{$b as h,E as T,Fb as b,Hb as f,I as V,Ib as a,La as k,Oa as u,Pc as O,Qc as P,Rc as D,Sb as R,Ub as L,Wb as c,Yb as _,Yc as A,Za as x,ac as C,bc as S,db as E,f as F,ha as d,hc as w,ia as m,ib as p,pb as y,v as M,vb as g,wb as o,xb as n,yb as N,zc as I}from"./chunk-S4NM23YD.js";var me=()=>({standalone:!0});function fe(s,t){s&1&&N(0,"mat-progress-spinner",7)}function pe(s,t){if(s&1){let e=b();o(0,"div",8),c(1),o(2,"button",9),f("click",function(){let r=d(e).$implicit,l=a();return m(l.closeToast(r))}),c(3,"\xD7"),n()()}if(s&2){let e=t.$implicit;L("show",e.visible),g("ngClass",e.type),u(),_(" ",e.message," ")}}function _e(s,t){if(s&1&&(o(0,"option",40),c(1),n()),s&2){let e=t.$implicit;g("ngValue",e.key),u(),_(" ",e.label," ")}}function he(s,t){s&1&&(o(0,"label",41),c(1," Valeur (%)"),n())}function Ce(s,t){if(s&1){let e=b();o(0,"div",42)(1,"input",43,1),f("input",function(r){d(e);let l=R(2),v=a(2);return m(v.checkMax(r,0,100,l))}),S("ngModelChange",function(r){d(e);let l=a(2);return C(l.regleCalcul.tauxRegleCalcul,r)||(l.regleCalcul.tauxRegleCalcul=r),m(r)}),n()()}if(s&2){let e=a(2);u(),h("ngModel",e.regleCalcul.tauxRegleCalcul)}}function Se(s,t){if(s&1&&(o(0,"li",44)(1,"a",45),c(2),n()()),s&2){let e=t.$implicit,i=t.index;u(),L("active",i===0),g("id","tab-"+e.key+"-tab"),y("href","#tab-"+e.key,k)("aria-controls","tab-"+e.key)("aria-selected",i===0),u(),_(" ",e.label," ")}}function xe(s,t){if(s&1){let e=b();o(0,"option",56),f("dblclick",function(){d(e);let r=a().$implicit,l=a(2);return m(l.moveSelectedToRight(r))}),c(1),n()}if(s&2){let e=t.$implicit,i=a().$implicit,r=a(2);g("selected",r.isSelectedLeft(e,i))("disabled",e.sousNature.idSousNature.toString()===r.selectedSousNatureId),u(),_(" ",e.sousNature.nomSousNature," ")}}function be(s,t){if(s&1){let e=b();o(0,"option",57),f("dblclick",function(){d(e);let r=a().$implicit,l=a(2);return m(l.moveSelectedToLeft(r))}),c(1),n()}if(s&2){let e=t.$implicit,i=a().$implicit,r=a(2);g("selected",r.isSelectedRight(e,i)),u(),_(" ",e.sousNature.nomSousNature," ")}}function ve(s,t){if(s&1){let e=b();o(0,"div",46)(1,"div",47)(2,"div",48)(3,"label"),c(4),n(),o(5,"input",49),S("ngModelChange",function(r){let l=d(e).$implicit;return C(l.leftFilter,r)||(l.leftFilter=r),m(r)}),f("ngModelChange",function(){let r=d(e).$implicit,l=a(2);return m(l.filterSubject.next({cat:r,side:"left"}))}),n(),o(6,"button",50),f("click",function(){let r=d(e).$implicit,l=a(2);return m(l.moveAllToRight(r))}),c(7,">>"),n(),N(8,"label",51),o(9,"button",50),f("click",function(){let r=d(e).$implicit,l=a(2);return m(l.moveSelectedToRight(r))}),c(10,">"),n(),o(11,"select",52),f("change",function(r){let l=d(e).$implicit,v=a(2);return m(v.onLeftSelectChange(r,l))}),p(12,xe,2,3,"option",53),n()(),o(13,"div",48)(14,"label"),c(15),n(),o(16,"input",54),S("ngModelChange",function(r){let l=d(e).$implicit;return C(l.rightFilter,r)||(l.rightFilter=r),m(r)}),f("ngModelChange",function(){let r=d(e).$implicit,l=a(2);return m(l.filterRight(r))}),n(),o(17,"button",50),f("click",function(){let r=d(e).$implicit,l=a(2);return m(l.moveAllToLeft(r))}),c(18,"<<"),n(),N(19,"label",51),o(20,"button",50),f("click",function(){let r=d(e).$implicit,l=a(2);return m(l.moveSelectedToLeft(r))}),c(21,">"),n(),o(22,"select",52),f("change",function(r){let l=d(e).$implicit,v=a(2);return m(v.onRightSelectChange(r,l))}),p(23,be,2,2,"option",55),n()()()()}if(s&2){let e=t.$implicit,i=t.index,r=a(2);L("show",i===0)("active",i===0),g("id","tab-"+e.key),y("aria-labelledby","tab-"+e.key+"-tab"),u(4),_("Showing all ",e.leftList.length),u(),h("ngModel",e.leftFilter),g("ngModelOptions",w(15,me)),u(7),g("ngForOf",e.filteredLeftList)("ngForTrackBy",r.trackBySousNatureId),u(3),_("Empty list ",e.rightList.length===0?"":"("+e.rightList.length+")"),u(),h("ngModel",e.rightFilter),g("ngModelOptions",w(16,me)),u(7),g("ngForOf",e.filteredRightList)}}function Ne(s,t){if(s&1){let e=b();o(0,"form",10,0),f("ngSubmit",function(){d(e);let r=a();return m(r.onSubmit())}),o(2,"div",11)(3,"div",12)(4,"label",13),c(5,"Nom "),o(6,"span",14),c(7,"*"),n()(),o(8,"div",15)(9,"select2",16),S("ngModelChange",function(r){d(e);let l=a();return C(l.selectedSousNatureId,r)||(l.selectedSousNatureId=r),m(r)}),f("update",function(){d(e);let r=a();return m(r.removeSelect())}),n()()(),o(10,"div",12)(11,"label",17),c(12," Op\xE9ration "),o(13,"span",14),c(14,"*"),n()(),o(15,"div",18)(16,"select",19),S("ngModelChange",function(r){d(e);let l=a();return C(l.regleCalcul.typeCalcul,r)||(l.regleCalcul.typeCalcul=r),m(r)}),o(17,"option",20),c(18,"-- S\xE9lectionnez une categorie --"),n(),p(19,_e,2,2,"option",21),n()(),o(20,"div",22)(21,"input",23),S("ngModelChange",function(r){d(e);let l=a();return C(l.TauxVariable,r)||(l.TauxVariable=r),m(r)}),n(),o(22,"label",24),c(23,"Taux variable"),n()(),p(24,he,2,0,"label",25)(25,Ce,3,1,"div",26),n(),o(26,"div",12),N(27,"label",27),o(28,"div",15)(29,"div",28)(30,"input",29),S("ngModelChange",function(r){d(e);let l=a();return C(l.cummulAnnee,r)||(l.cummulAnnee=r),m(r)}),n(),o(31,"label",30),c(32,"Cummulable par ann\xE9e"),n()()()(),o(33,"div",12)(34,"h4",31),c(35,"categories"),n(),o(36,"ul",32),p(37,Se,3,7,"li",33),n(),o(38,"div",34),p(39,ve,24,17,"div",35),n()()(),o(40,"div",36)(41,"button",37),N(42,"i",38),c(43),n(),o(44,"button",39),f("click",function(){d(e);let r=a();return m(r.close())}),c(45,"Fermer"),n()()()}if(s&2){let e=R(1),i=a();u(9),g("data",i.data),h("ngModel",i.selectedSousNatureId),g("styleMode","noStyle")("placeholder","S\xE9lectionner une sous-nature"),u(7),h("ngModel",i.regleCalcul.typeCalcul),u(3),g("ngForOf",i.typeRegleList),u(2),h("ngModel",i.TauxVariable),u(3),g("ngIf",!i.TauxVariable),u(),g("ngIf",!i.TauxVariable),u(5),h("ngModel",i.cummulAnnee),u(7),g("ngForOf",i.typeCategorieList),u(2),g("ngForOf",i.dualList),u(2),g("disabled",!e.form.valid||i.loading),u(2),_(" ",i.bSaveName," ")}}function Le(s,t){s&1&&(o(0,"h3",58),c(1,"Aucune Regle \xE0 \xE9diter..."),n())}var ge=class s{constructor(t,e,i,r,l,v){this.regleCalculService=t;this.sousNatureService=e;this.natureService=i;this.cdr=r;this.router=l;this.globalFonctionService=v}regleCalcul;natures=[];sousNatures=[];newSousNatures=[];sousNature_natures=[];isLoading=!1;isAddForm=!1;bSaveName="Enregistrer";serverErrors=[];creationSuccess=!1;loading=!1;data=[];selectedSousNatureId="";typeRegleList;dualList=[];cummulAnnee=!1;TauxVariable=!1;typeCategorieList=Object.entries(oe).map(([t,e])=>({key:t,label:e}));toasts=[];showToast(t,e="success"){let i={message:t,type:e,visible:!1};this.toasts.push(i),requestAnimationFrame(()=>{i.visible=!0}),i.timeout=setTimeout(()=>this.closeToast(i),3e3)}closeToast(t){clearTimeout(t.timeout),t.visible=!1,setTimeout(()=>{this.toasts=this.toasts.filter(e=>e!==t)},400)}filterSubject=new F;ngOnInit(){this.filterSubject.pipe(T(200)).subscribe(({cat:t,side:e})=>{e==="left"?this.filterLeft(t):this.filterRight(t)}),this.typeRegleList=Object.entries(de).map(([t,e])=>({key:t,label:e})),this.regleCalcul&&((this.router.url.includes("/create")||this.regleCalcul.idRegleCalcul===-1)&&(this.isAddForm=!0),this.regleCalcul.detailRegleCalcul.includes("cummulAnnee")&&(this.cummulAnnee=!0),this.regleCalcul.detailRegleCalcul.includes("tauxVariable")&&(this.TauxVariable=!0)),this.bSaveName=this.isAddForm?"Enregistrer":"Modifier",this.loadData()}trackBySousNatureId(t,e){return e.sousNature.idSousNature}groupPerCat(){this.typeCategorieList.forEach(t=>{console.log("groupPerCat = ",this.sousNature_natures.filter(i=>i.nature.typeNature===t.key));let e=this.sousNature_natures.filter(i=>i.nature.typeNature===t.key);this.dualList.push({key:t.key,label:t.label,leftList:e,rightList:[],filteredLeftList:[...e],filteredRightList:[],leftFilter:"",rightFilter:"",selectedLeft:[],selectedRight:[]})})}loadData(){this.isLoading=!0,M({sousNatures:this.sousNatureService.listSousNatures(0,1e3),natures:this.natureService.listNatures(1,1e3)}).subscribe({next:({sousNatures:t,natures:e})=>{this.sousNatures=t.data.sous_natures,this.natures=e.data.base_natures,this.newSousNatures=this.globalFonctionService.mergeUnique(this.newSousNatures,this.sousNatures,i=>i.idSousNature),this.data=this.buildSelect2Data(this.newSousNatures,this.natures),this.buildSousNatureNature(),this.groupPerCat(),setTimeout(()=>{this.regleCalcul?.idSousNature?this.selectedSousNatureId=this.regleCalcul.idSousNature.toString():this.selectedSousNatureId="",this.regleCalcul.sous_natures_entree.length>0&&this.setEditSelectToRight(),this.isLoading=!1,this.cdr.detectChanges()})},error:()=>this.isLoading=!1})}setEditSelectToRight(){this.dualList.forEach(t=>{let e=t.leftList.filter(i=>this.regleCalcul.sous_natures_entree.some(r=>i.sousNature.idSousNature===r.idSousNature));e.length>0&&(t.rightList.push(...e),t.leftList=t.leftList.filter(i=>!e.includes(i)),this.filterLeft(t),this.filterRight(t))})}removeSelect(){this.dualList.forEach(t=>{let e=t.rightList.filter(i=>i.sousNature.idSousNature.toString()===this.selectedSousNatureId);e.length>0&&(t.leftList.push(...e),t.rightList=t.rightList.filter(i=>i.sousNature.idSousNature.toString()!==this.selectedSousNatureId),this.filterLeft(t),this.filterRight(t))})}buildSousNatureNature(){this.sousNature_natures=this.newSousNatures.map(t=>{let e=this.natures.find(i=>i.idNature===t.idNature);return{sousNature:t,nature:e??{}}})}buildSelect2Data(t,e){return e.map(i=>{let r=t.filter(l=>l.idNature===i.idNature&&l.idSousNature>=0).map(l=>({value:l.idSousNature.toString(),label:l.nomSousNature,id:l.idSousNature.toString()}));return{label:i.nomNature,data:{name:i.idNature},options:r}}).filter(i=>i.options.length>0)}checkMax(t,e,i,r){let l=this.globalFonctionService.limitValue(t.target.value,e,i);t.target.value=l,r&&r.control.setValue(l,{emitEvent:!1})}close(){this.router.navigate(["regle-calculs/"])}onSubmit(){this.creationSuccess=!1,this.serverErrors=[],this.loading=!0,this.regleCalcul.idSousNature=+this.selectedSousNatureId,this.regleCalcul.detailRegleCalcul=" ",this.cummulAnnee&&(this.regleCalcul.detailRegleCalcul+=`cummulAnnee
`),this.TauxVariable&&(this.regleCalcul.detailRegleCalcul+="tauxVariable"),this.regleCalcul.sous_natures_entree=[],this.dualList.forEach(e=>{e.rightList.forEach(i=>{let r={idRegleCalcul_Log:0,idSousNature:i.sousNature.idSousNature,idRegleCalcul:this.regleCalcul.idRegleCalcul,status:!0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()};this.regleCalcul.sous_natures_entree.push(r)})}),(this.isAddForm?this.regleCalculService.createRegleCalcul(this.regleCalcul):this.regleCalculService.updateRegleCalcul(this.regleCalcul)).pipe(V(()=>this.loading=!1)).subscribe({next:e=>{e?(this.creationSuccess=!0,this.isAddForm?(console.log("Sauvegarde r\xE9ussie",e),this.selectedSousNatureId="",this.cummulAnnee=!1,this.regleCalcul={idRegleCalcul:-1,idSousNature:-1,typeCalcul:"",tauxRegleCalcul:0,detailRegleCalcul:"",sous_natures_entree:[],status:!0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()},this.emptyRight(),this.showToast(["Sauvegarde r\xE9ussie !"],"success")):this.showToast(["Modification r\xE9ussie !"],"success")):this.showToast(["Une erreur est survenue lors de l'enregistrement"],"error")},error:e=>{this.serverErrors.push(e.error?.message||"Erreur inconnue."),this.showToast(this.serverErrors,"error")}})}emptyRight(){this.dualList.forEach(t=>{t.leftList.push(...t.rightList),t.rightList=[],this.filterLeft(t),this.filterRight(t)})}moveSelectedToRight(t){if(!t.selectedLeft||t.selectedLeft.length===0)return;let e=t.leftList.filter(i=>t.selectedLeft.some(r=>i===r)&&i.sousNature.idSousNature.toString()!==this.selectedSousNatureId);t.rightList.push(...e),t.leftList=t.leftList.filter(i=>!e.includes(i)),t.selectedLeft=[],this.filterLeft(t),this.filterRight(t)}moveSelectedToLeft(t){!t.selectedRight||t.selectedRight.length===0||(t.leftList.push(...t.rightList.filter(e=>t.selectedRight.some(i=>e===i))),t.rightList=t.rightList.filter(e=>!t.selectedRight.some(i=>e===i)),t.selectedRight=[],this.filterLeft(t),this.filterRight(t))}moveAllToRight(t){let e=t.leftList.filter(i=>i.sousNature.idSousNature.toString()!==this.selectedSousNatureId);t.rightList=t.rightList.concat(e),t.leftList=t.leftList.filter(i=>i.sousNature.idSousNature.toString()===this.selectedSousNatureId),this.filterLeft(t),this.filterRight(t)}moveAllToLeft(t){t.leftList=t.leftList.concat(t.rightList),t.rightList=[],this.filterLeft(t),this.filterRight(t)}isSelectedLeft(t,e){return e.selectedLeft.includes(t)}isSelectedRight(t,e){return e.selectedRight.includes(t)}onLeftSelectChange(t,e){let i=t.target;e.selectedLeft=Array.from(i.selectedOptions).map(r=>e.filteredLeftList.find(l=>l.sousNature.nomSousNature===r.text)),console.log("onLeftSelectChange += ",e.selectedLeft)}onRightSelectChange(t,e){let i=t.target;e.selectedRight=Array.from(i.selectedOptions).map(r=>e.filteredRightList.find(l=>l.sousNature.nomSousNature===r.text))}filterLeft(t){t.filteredLeftList=t.leftList.filter(e=>e.sousNature.nomSousNature.toLowerCase().includes(t.leftFilter.toLowerCase()))}filterRight(t){t.filteredRightList=t.rightList.filter(e=>e.sousNature.nomSousNature.toLowerCase().includes(t.rightFilter.toLowerCase()))}static \u0275fac=function(e){return new(e||s)(x(ae),x(se),x(ne),x(I),x(W),x(ue))};static \u0275cmp=E({type:s,selectors:[["app-regle-calculs-form"]],inputs:{regleCalcul:"regleCalcul"},decls:5,vars:4,consts:[["regleCalculForm","ngForm"],["tauxRegleCalcul","ngModel"],["mode","indeterminate","diameter","50","style","display: block; margin: 0 auto;",4,"ngIf"],[1,"toast-container"],["class","toast",3,"ngClass","show",4,"ngFor","ngForOf"],["class","form-horizontal",3,"ngSubmit",4,"ngIf"],["class","center",4,"ngIf"],["mode","indeterminate","diameter","50",2,"display","block","margin","0 auto"],[1,"toast",3,"ngClass"],[1,"close-btn",3,"click"],[1,"form-horizontal",3,"ngSubmit"],[1,"card-body"],[1,"form-group","row"],["for","nomSousNature",1,"col-sm-2","col-form-label"],[1,"text-danger"],[1,"col-sm-10"],["required","","name","selectedSousNatureId",1,"form-control",3,"ngModelChange","update","data","ngModel","styleMode","placeholder"],["for","typeCalcul",1,"col-sm-2","col-form-label"],[1,"col-sm-2"],["data-select2-id","1","tabindex","-1","aria-hidden","true","required","","name","typeCalcul",1,"form-control","select2","select2-hidden-accessible",2,"width","100%",3,"ngModelChange","ngModel"],["value","","disabled","","selected",""],[3,"ngValue",4,"ngFor","ngForOf"],[1,"mb-3","form-check","col-sm-2"],["type","checkbox","id","TauxVariable","name","TauxVariable",1,"form-check-input",3,"ngModelChange","ngModel"],["for","TauxVariable",1,"form-check-label"],["for","tauxRegleCalcul","class","col-sm-2 col-form-label",4,"ngIf"],["class","col-sm-4",4,"ngIf"],["for","typeNature",1,"col-sm-2","col-form-label"],[1,"mb-3","form-check"],["type","checkbox","id","cummulAnnee","name","cummulAnnee",1,"form-check-input",3,"ngModelChange","ngModel"],["for","cummulAnnee",1,"form-check-label"],[1,"mt-0"],["id","custom-content-above-tab","role","tablist",1,"nav","nav-tabs"],["class","nav-item",4,"ngFor","ngForOf"],["id","custom-content-above-tabContent",1,"tab-content"],["class","tab-pane fade","role","tabpanel",3,"id","show","active",4,"ngFor","ngForOf"],[1,"card-footer"],["type","submit",1,"btn","btn-info",3,"disabled"],[1,"fas","fa-save","mr-2"],["type","button",1,"btn","btn-secondary","float-end",3,"click"],[3,"ngValue"],["for","tauxRegleCalcul",1,"col-sm-2","col-form-label"],[1,"col-sm-4"],["type","text","id","tauxRegleCalcul","placeholder","Taux (%)","maxlength","80","step","1","name","tauxRegleCalcul",1,"form-control",3,"input","ngModelChange","ngModel"],[1,"nav-item"],["data-toggle","pill","role","tab",1,"nav-link",3,"id"],["role","tabpanel",1,"tab-pane","fade",3,"id"],[1,"duallistbox-container",2,"display","flex","gap","1rem","align-items","center"],[1,"list-box",2,"flex","1"],["type","text",1,"form-control","mb-2",3,"ngModelChange","ngModel","ngModelOptions"],["type","button",1,"btn","btn-outline-secondary","btn-block","mb-2","col-sm-5",3,"click"],[1,"col-sm-2","col-form-label"],["multiple","","size","10",1,"form-control",2,"width","100%",3,"change"],[3,"selected","disabled","dblclick",4,"ngFor","ngForOf","ngForTrackBy"],["type","text","placeholder","Filter",1,"form-control","mb-2",3,"ngModelChange","ngModel","ngModelOptions"],[3,"selected","dblclick",4,"ngFor","ngForOf"],[3,"dblclick","selected","disabled"],[3,"dblclick","selected"],[1,"center"]],template:function(e,i){e&1&&(p(0,fe,1,0,"mat-progress-spinner",2),o(1,"div",3),p(2,pe,4,4,"div",4),n(),p(3,Ne,46,14,"form",5)(4,Le,2,0,"h3",6)),e&2&&(g("ngIf",i.isLoading),u(2),g("ngForOf",i.toasts),u(),g("ngIf",i.regleCalcul&&!i.isLoading),u(),g("ngIf",!i.regleCalcul))},dependencies:[Y,H,J,K,B,j,U,z,$,Q,X,G,q,Z,te,ie,re,A,O,P,D,le,ce,ee],styles:[".grayed-out[_ngcontent-%COMP%]{color:#999;background-color:#f0f0f0}.builder-container[_ngcontent-%COMP%]{max-width:800px;margin:30px auto;padding:25px;border-radius:10px;background:#fafafa;box-shadow:0 2px 10px #0000001a;font-family:Segoe UI,sans-serif}.formule-display[_ngcontent-%COMP%]{margin-top:10px;margin-bottom:20px}.formule-box[_ngcontent-%COMP%]{background:#eee;border:1px solid #ccc;padding:10px;border-radius:5px;min-height:40px;font-family:monospace}.clear[_ngcontent-%COMP%]{background-color:#dc3545}.clear[_ngcontent-%COMP%]:hover{background-color:#a71d2a}.save[_ngcontent-%COMP%]{background-color:#28a745}.save[_ngcontent-%COMP%]:hover{background-color:#1e7e34}.calc[_ngcontent-%COMP%]{background-color:#17a2b8}.calc[_ngcontent-%COMP%]:hover{background-color:#117a8b}.result[_ngcontent-%COMP%]{margin-top:15px;font-size:18px;background:#e3f7e6;border:1px solid #a4d7b5;padding:10px;border-radius:5px;color:#155724}.toast-container[_ngcontent-%COMP%]{position:fixed;top:20px;right:20px;display:flex;flex-direction:column;gap:10px;z-index:9999}.toast[_ngcontent-%COMP%]{min-width:220px;padding:12px 16px;border-radius:6px;color:#fff;box-shadow:0 4px 12px #00000040;font-size:14px;display:flex;justify-content:space-between;align-items:center;opacity:0;transform:translate(100%);transition:transform .4s ease,opacity .4s ease}.toast.show[_ngcontent-%COMP%]{opacity:1;transform:translate(0)}.toast.success[_ngcontent-%COMP%]{background-color:#4caf50}.toast.error[_ngcontent-%COMP%]{background-color:#f44336}.toast[_ngcontent-%COMP%]   .close-btn[_ngcontent-%COMP%]{background:none;border:none;color:#fff;font-size:16px;line-height:1;cursor:pointer}"]})};export{ge as a};
