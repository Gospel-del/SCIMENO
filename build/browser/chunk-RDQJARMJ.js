import{a as ce}from"./chunk-LQZFU4YQ.js";import{a as ue}from"./chunk-L76IVEF3.js";import{b as ae,c as se}from"./chunk-V2VNRVT6.js";import{d as Q,f as Z,j as ee,k as te}from"./chunk-ZJQO5VS5.js";import{a as le}from"./chunk-3ICLOKWM.js";import{b as ne}from"./chunk-BC2RRGYI.js";import{b as oe}from"./chunk-AWQM7IIM.js";import{a as re,c as ie}from"./chunk-VMKVCHVW.js";import{a as K}from"./chunk-MNJUUXAV.js";import{e as A,f as j,g as U,i as $,j as q,n as W,o as G,p as H,s as J,w as X,x as Y}from"./chunk-LTEV2KH7.js";import{i as z}from"./chunk-NKZL4UVF.js";import{$b as w,Fb as S,Hb as d,I as k,Ib as s,Oa as f,Pc as B,Qc as P,Rc as D,Sb as I,Ub as O,Wb as l,Xb as N,Yb as h,Yc as L,Za as _,ac as E,bc as y,db as V,ha as u,hc as T,ia as c,ib as b,v as M,vb as g,wb as o,xb as n,yb as F,zc as R}from"./chunk-S4NM23YD.js";var de=()=>[1,2,3,4,5,6,7,8,9,0];function pe(m,i){m&1&&F(0,"mat-progress-spinner",5)}function fe(m,i){if(m&1){let e=S();o(0,"div",6),l(1),o(2,"button",7),d("click",function(){let r=u(e).$implicit,a=s();return c(a.closeToast(r))}),l(3,"\xD7"),n()()}if(m&2){let e=i.$implicit;O("show",e.visible),g("ngClass",e.type),f(),h(" ",e.message," ")}}function ge(m,i){if(m&1&&(o(0,"option",33),l(1),n()),m&2){let e=i.$implicit;g("ngValue",e.key),f(),h(" ",e.label," ")}}function _e(m,i){if(m&1){let e=S();o(0,"button",24),d("click",function(){let r=u(e).$implicit,a=s(2);return c(a.addElement(r.toString()))}),l(1),n()}if(m&2){let e=i.$implicit;f(),N(e)}}function be(m,i){if(m&1){let e=S();o(0,"option",34),d("dblclick",function(){let r=u(e).$implicit,a=s(2);return c(a.addElementNature(r))}),l(1),n()}if(m&2){let e=i.$implicit,t=s(2);g("disabled",e.idNature.toString()===t.selectedSousNatureId),f(),h(" ",e.nomNature," ")}}function xe(m,i){if(m&1){let e=S();o(0,"form",8,0),d("ngSubmit",function(){u(e);let r=s();return c(r.onSubmit())}),o(2,"div",9)(3,"div",10)(4,"label",11),l(5,"Nom"),n(),o(6,"div",12)(7,"select2",13),y("ngModelChange",function(r){u(e);let a=s();return E(a.selectedSousNatureId,r)||(a.selectedSousNatureId=r),c(r)}),n()(),o(8,"label",14),l(9,"Indicateur ID"),n(),o(10,"div",12)(11,"select",15),y("ngModelChange",function(r){u(e);let a=s();return E(a.regleCalcul.typeCalcul,r)||(a.regleCalcul.typeCalcul=r),c(r)}),o(12,"option",16),l(13,"-- S\xE9lectionnez une categorie --"),n(),b(14,ge,2,2,"option",17),n()()(),o(15,"div",10)(16,"label",18),l(17,"Formule actuelle "),n(),o(18,"div",19)(19,"div",20),l(20),n(),o(21,"button",21),d("click",function(){u(e);let r=s();return c(r.clearFormula())}),l(22,"Effacer"),n()()(),o(23,"div",10)(24,"label",18),l(25,"Chiffres"),n(),o(26,"div",22),b(27,_e,2,1,"button",23),o(28,"button",24),d("click",function(){u(e);let r=s();return c(r.addElement("."))}),l(29,"."),n()(),o(30,"label",18),l(31,"Op\xE9rateurs"),n(),o(32,"div",22)(33,"button",24),d("click",function(){u(e);let r=s();return c(r.addElement(" + "))}),l(34,"+"),n(),o(35,"button",24),d("click",function(){u(e);let r=s();return c(r.addElement(" - "))}),l(36,"-"),n(),o(37,"button",24),d("click",function(){u(e);let r=s();return c(r.addElement(" * "))}),l(38,"*"),n(),o(39,"button",24),d("click",function(){u(e);let r=s();return c(r.addElement(" / "))}),l(40,"/"),n(),o(41,"button",24),d("click",function(){u(e);let r=s();return c(r.addElement(" .^ "))}),l(42,"^"),n(),o(43,"button",24),d("click",function(){u(e);let r=s();return c(r.addElement("("))}),l(44,"("),n(),o(45,"button",24),d("click",function(){u(e);let r=s();return c(r.addElement(")"))}),l(46,")"),n(),o(47,"button",24),d("click",function(){u(e);let r=s();return c(r.addElement(" ANNEE "))}),l(48,"ANNEE"),n()(),o(49,"label",18),l(50,"Fonctions"),n(),o(51,"div",22)(52,"button",24),d("click",function(){u(e);let r=s();return c(r.addElement("SOMME("))}),l(53,"SOMME("),n(),o(54,"button",24),d("click",function(){u(e);let r=s();return c(r.addElement("CUMMUL("))}),l(55,"CUMMUL("),n()()(),F(56,"br"),o(57,"div",25)(58,"label",18),l(59,"Liste des natures"),n(),o(60,"div",26)(61,"div",27)(62,"select",28),b(63,be,2,2,"option",29),n()()()()(),o(64,"div",30)(65,"button",31),l(66),n(),o(67,"button",32),d("click",function(){u(e);let r=s();return c(r.close())}),l(68,"Fermer"),n()()()}if(m&2){let e=I(1),t=s();f(7),g("data",t.data),w("ngModel",t.selectedSousNatureId),g("styleMode","noStyle")("placeholder","S\xE9lectionner une nature"),f(4),w("ngModel",t.regleCalcul.typeCalcul),f(3),g("ngForOf",t.typeRegleList),f(6),N(t.formule||"--- vide ---"),f(7),g("ngForOf",T(12,de)),f(36),g("ngForOf",t.natures)("ngForTrackBy",t.trackByNatureId),f(2),g("disabled",!e.form.valid),f(),h(" ",t.bSaveName," ")}}var me=class m{constructor(i,e,t,r,a,x){this.natureService=i;this.regleCalculService=e;this.globalFonctionService=t;this.sousNatureService=r;this.cdr=a;this.router=x;this.math.import({SOMME:(...p)=>p.reduce((C,v)=>C+v,0),MOYENNE:(...p)=>p.reduce((C,v)=>C+v,0)/p.length,MIN:(...p)=>Math.min(...p),MAX:(...p)=>Math.max(...p)})}regleCalcul;isAddForm=!1;bSaveName="Enregistrer";serverErrors=[];creationSuccess=!1;natures=[];sousNatures=[];newSousNatures=[];selectedSousNatureId="-5";isLoading=!1;formuleSave="";formule="";nomFormule="";description="";result=null;valeurs={};data=[];typeCategorieList=Object.entries(re).map(([i,e])=>({key:i,label:e}));typeRegleList=Object.entries(ce).map(([i,e])=>({key:i,label:e}));math=se(ae);toasts=[];showToast(i,e="success"){let t={message:i,type:e,visible:!1};this.toasts.push(t),requestAnimationFrame(()=>{t.visible=!0}),t.timeout=setTimeout(()=>this.closeToast(t),3e3)}closeToast(i){clearTimeout(i.timeout),i.visible=!1,setTimeout(()=>{this.toasts=this.toasts.filter(e=>e!==i)},400)}ngOnInit(){this.regleCalcul&&(this.router.url.includes("/create")||this.regleCalcul.idRegleCalcul===-1)&&(this.isAddForm=!0),this.bSaveName=this.isAddForm?"Enregistrer":"Modifier",this.loadData()}loadData(){this.isLoading=!0,M({sousNatures:this.sousNatureService.listSousNatures(0,1e3),natures:this.natureService.listNatures(1,1e3),regleCalculs:this.regleCalculService.listRegleCalculs(1,1e3)}).subscribe({next:({sousNatures:i,natures:e,regleCalculs:t})=>{i&&i.success&&i.data&&e&&e.success&&e.data&&t&&t.success&&t.data&&(this.sousNatures=i.data.sous_natures,this.natures=e.data.base_natures,t=t.data.regles_calcul,this.newSousNatures=this.globalFonctionService.mergeUnique(this.newSousNatures,this.sousNatures,r=>r.idSousNature),this.data=this.buildSelect2Data(this.newSousNatures,this.natures,t),setTimeout(()=>{this.cdr.detectChanges(),this.regleCalcul?.idSousNature?this.selectedSousNatureId=this.regleCalcul.idSousNature.toString():this.selectedSousNatureId="",this.regleCalcul?.detailRegleCalcul&&(this.formuleSave=this.regleCalcul.detailRegleCalcul,this.formule=this.remplacerIdsParNoms(this.regleCalcul.detailRegleCalcul,this.natures)),this.isLoading=!1}))},error:()=>this.isLoading=!1})}buildSelect2Data(i,e,t){let r=t.filter(a=>a.idRegleCalcul!==this.regleCalcul.idRegleCalcul).map(a=>a.idSousNature);return e.filter(a=>a.typeNature==="IND").map(a=>{let x=i.filter(p=>p.idNature===a.idNature&&!r.includes(p.idSousNature)).map(p=>({value:p.idSousNature.toString(),label:p.nomSousNature,id:p.idSousNature.toString()}));return{label:a.nomNature,data:{name:a.idNature},options:x}}).filter(a=>a.options.length>0)}remplacerIdsParNoms(i,e){return i.replace(/\bid(-?\d+)\b/g,(t,r)=>{let a=Number(r),x=e.find(p=>p.idNature===a);return x?x.nomNature:`INCONNU_${a}`})}addElement(i){this.formule+=i,this.formuleSave+=i}addElementNature(i){this.formule+=i.nomNature,this.formuleSave+="id"+i.idNature}clearFormula(){this.formule="",this.formuleSave="",this.result=null}trackByNatureId(i,e){return e.idNature}calculateLocal(){if(!this.formule){alert("Veuillez d\u2019abord cr\xE9er une formule.");return}let i=this.formuleSave;Object.entries(this.valeurs).forEach(([e,t])=>{let r=new RegExp(`\\b${e}\\b`,"g");i=i.replace(r,t.toString())});try{let e=this.math.evaluate(i);this.result=e,alert("result : "+e)}catch(e){alert("\u274C Erreur dans la formule : "+e.message)}}getVariablesFromFormula(){let i=/\b\d+\b/g,e=this.formule.match(i);return e?[...new Set(e)]:[]}onSubmit(){if(!this.formuleSave){alert("Veuillez d\u2019abord cr\xE9er une formule.");return}let i=this.validateExpression(this.formuleSave);if(i){this.showToast([`Formule invalide : ${i}`],"error");return}this.regleCalcul.idSousNature=+this.selectedSousNatureId,this.regleCalcul.tauxRegleCalcul=100,this.regleCalcul.detailRegleCalcul=this.formuleSave,this.regleCalcul.sous_natures_entree=[],(this.isAddForm?this.regleCalculService.createRegleCalcul(this.regleCalcul):this.regleCalculService.updateRegleCalcul(this.regleCalcul)).pipe(k(()=>this.isLoading=!1)).subscribe({next:t=>{t?(this.creationSuccess=!0,console.log("Sauvegarde r\xE9ussie",t),this.isAddForm?(this.selectedSousNatureId="",this.clearFormula(),this.loadData(),this.regleCalcul={idRegleCalcul:-1,idSousNature:-1,typeCalcul:"",tauxRegleCalcul:0,detailRegleCalcul:"",sous_natures_entree:[],status:!0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()},this.showToast(["Sauvegarde r\xE9ussie !"],"success")):this.showToast(["Modification r\xE9ussie !"],"success")):this.showToast(["Une erreur est survenue lors de l'enregistrement"],"error")},error:t=>{this.serverErrors.push(t.error?.message||"Erreur inconnue."),this.showToast(this.serverErrors,"error")}})}close(){this.router.navigate(["indicateur-cle/"])}validateExpression(i){let e=i.trim(),t=0;for(let r of e)if(r==="("&&t++,r===")"&&t--,t<0)return"Parenth\xE8se fermante inattendue.";return t!==0?"Les parenth\xE8ses ne sont pas \xE9quilibr\xE9es.":/[\+\-\*\/]{2,}/.test(e.replace(/\s+/g,""))?"Op\xE9rateurs cons\xE9cutifs invalides.":/[\+\-\*\/]\s*$/.test(e)?"Expression se termine par un op\xE9rateur.":/[\+\-\*\/]\s*\)/.test(e)?"Op\xE9rateur avant une parenth\xE8se fermante.":/\(\s*[\+\-\*\/]/.test(e)?"Op\xE9rateur apr\xE8s une parenth\xE8se ouvrante.":/id(?!-?\d)/.test(e)?"Identifiant 'id' invalide (ex: id doit \xEAtre suivi d'un nombre).":null}static \u0275fac=function(e){return new(e||m)(_(ie),_(ne),_(le),_(oe),_(R),_(z))};static \u0275cmp=V({type:m,selectors:[["app-formule-builder-form"]],inputs:{regleCalcul:"regleCalcul"},decls:4,vars:3,consts:[["natureForm","ngForm"],["mode","indeterminate","diameter","50","style","display: block; margin: 0 auto;",4,"ngIf"],[1,"toast-container"],["class","toast",3,"ngClass","show",4,"ngFor","ngForOf"],["class","form-horizontal",3,"ngSubmit",4,"ngIf"],["mode","indeterminate","diameter","50",2,"display","block","margin","0 auto"],[1,"toast",3,"ngClass"],[1,"close-btn",3,"click"],[1,"form-horizontal",3,"ngSubmit"],[1,"card-body"],[1,"form-group","row"],["for","nomSousNature",1,"col-sm-2","col-form-label"],[1,"col-sm-4"],["required","","name","selectedSousNatureId",1,"form-control",3,"ngModelChange","data","ngModel","styleMode","placeholder"],["for","indicateurID",1,"col-sm-2","col-form-label"],["data-select2-id","1","tabindex","-1","aria-hidden","true","required","","name","typeCalcul",1,"form-control","select2","select2-hidden-accessible",2,"width","100%",3,"ngModelChange","ngModel"],["value","","disabled","","selected",""],[3,"ngValue",4,"ngFor","ngForOf"],[1,"col-sm-2","col-form-label"],[1,"col-sm-12"],["id","formule",1,"formule-box"],["type","button",1,"clear","col-sm-12",3,"click"],[1,"col-sm-2"],["type","button",3,"click",4,"ngFor","ngForOf"],["type","button",3,"click"],[1,"functions","row"],[1,"duallistbox-container",2,"display","flex","gap","1rem","align-items","center"],[1,"list-box",2,"flex","1"],["multiple","","size","10",1,"form-control",2,"width","100%"],[3,"disabled","dblclick",4,"ngFor","ngForOf","ngForTrackBy"],[1,"card-footer"],["type","submit",1,"btn","btn-info",3,"disabled"],["type","button",1,"btn","btn-secondary","float-end",3,"click"],[3,"ngValue"],[3,"dblclick","disabled"]],template:function(e,t){e&1&&(b(0,pe,1,0,"mat-progress-spinner",1),o(1,"div",2),b(2,fe,4,4,"div",3),n(),b(3,xe,69,13,"form",4)),e&2&&(g("ngIf",t.isLoading),f(2),g("ngForOf",t.toasts),f(),g("ngIf",t.regleCalcul&&!t.isLoading))},dependencies:[X,q,G,H,W,A,j,J,$,U,Y,Q,Z,ee,L,B,P,D,te,ue,K],styles:[".builder-container[_ngcontent-%COMP%]{max-width:800px;margin:30px auto;padding:25px;border-radius:10px;background:#fafafa;box-shadow:0 2px 10px #0000001a;font-family:Segoe UI,sans-serif}button[_ngcontent-%COMP%]{margin:4px;padding:6px 12px;background-color:#007bff;border:none;color:#fff;border-radius:4px;cursor:pointer;transition:.2s}button[_ngcontent-%COMP%]:hover{background-color:#0056b3}.btn-group[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px}.formule-display[_ngcontent-%COMP%]{margin-top:10px;margin-bottom:20px}.formule-box[_ngcontent-%COMP%]{background:#eee;border:1px solid #ccc;padding:10px;border-radius:5px;min-height:40px;font-family:monospace}.clear[_ngcontent-%COMP%]{background-color:#dc3545}.clear[_ngcontent-%COMP%]:hover{background-color:#a71d2a}.save[_ngcontent-%COMP%]{background-color:#28a745}.save[_ngcontent-%COMP%]:hover{background-color:#1e7e34}.calc[_ngcontent-%COMP%]{background-color:#17a2b8}.calc[_ngcontent-%COMP%]:hover{background-color:#117a8b}.result[_ngcontent-%COMP%]{margin-top:15px;font-size:18px;background:#e3f7e6;border:1px solid #a4d7b5;padding:10px;border-radius:5px;color:#155724}.toast-container[_ngcontent-%COMP%]{position:fixed;top:20px;right:20px;display:flex;flex-direction:column;gap:10px;z-index:9999}.toast[_ngcontent-%COMP%]{min-width:220px;padding:12px 16px;border-radius:6px;color:#fff;box-shadow:0 4px 12px #00000040;font-size:14px;display:flex;justify-content:space-between;align-items:center;opacity:0;transform:translate(100%);transition:transform .4s ease,opacity .4s ease}.toast.show[_ngcontent-%COMP%]{opacity:1;transform:translate(0)}.toast.success[_ngcontent-%COMP%]{background-color:#4caf50}.toast.error[_ngcontent-%COMP%]{background-color:#f44336}.toast[_ngcontent-%COMP%]   .close-btn[_ngcontent-%COMP%]{background:none;border:none;color:#fff;font-size:16px;line-height:1;cursor:pointer}"]})};export{me as a};
